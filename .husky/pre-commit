#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."
echo ""

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Check if any plist files are being committed
if echo "$STAGED_FILES" | grep -q "\.plist$"; then
  echo "üìã Validating plist files..."
  for file in $(echo "$STAGED_FILES" | grep "\.plist$"); do
    if [ -f "$file" ]; then
      plutil -lint "$file" || {
        echo "‚ùå Invalid plist file: $file"
        echo "Run: plutil -lint $file"
        exit 1
      }
    fi
  done
  echo "‚úÖ All plist files valid"
  echo ""
fi

# Check if any Rust files are being committed
if echo "$STAGED_FILES" | grep -q "\.rs$"; then
  echo "ü¶Ä Running Rust linter..."
  cd src-tauri
  cargo clippy --all-targets --all-features -- -D warnings || {
    echo "‚ùå Rust lint failed"
    echo "Run: cd src-tauri && cargo clippy"
    exit 1
  }
  cd ..
  echo "‚úÖ Rust lint passed"
  echo ""
fi

# Check if any frontend files are being committed
if echo "$STAGED_FILES" | grep -qE "\.(svelte|ts|js)$"; then
  echo "‚ö° Checking Svelte/TypeScript..."
  npm run check || {
    echo "‚ùå Svelte/TypeScript check failed"
    echo "Run: npm run check"
    exit 1
  }
  echo "‚úÖ Frontend check passed"
  echo ""
fi

echo "‚ú® All pre-commit checks passed!"
